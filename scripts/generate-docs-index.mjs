import fs from "fs";
import path from "path";

const contentDirectory = path.join(process.cwd(), "src/content/docs");
const outputPath = path.join(process.cwd(), "src/content/docs.generated.ts");

function parseFrontmatter(content) {
  const frontmatterRegex = /^---\n([\s\S]*?)\n---\n/;
  const match = content.match(frontmatterRegex);

  if (!match) {
    return { content, meta: {} };
  }

  const frontmatter = match[1];
  const meta = {};

  frontmatter.split("\n").forEach((line) => {
    const [key, ...valueParts] = line.split(":");
    if (key && valueParts.length > 0) {
      meta[key.trim()] = valueParts
        .join(":")
        .trim()
        .replace(/^["']|["']$/g, "");
    }
  });

  return { content: content.slice(match[0].length), meta };
}

function normalizeOrder(value) {
  if (!value) return undefined;
  const parsed = Number.parseInt(value, 10);
  return Number.isNaN(parsed) ? undefined : parsed;
}

function buildLocaleDocs(locale) {
  if (!fs.existsSync(contentDirectory)) {
    return {};
  }

  const files = fs.readdirSync(contentDirectory).sort();
  const entries = [];

  for (const file of files) {
    const isZhFile = /\.zh\.mdx?$/.test(file);

    if (locale === "zh" && !isZhFile) continue;
    if (locale !== "zh" && (isZhFile || !/\.mdx?$/.test(file))) continue;

    const slug = file
      .replace(/\.zh\.mdx?$/, "")
      .replace(/\.mdx?$/, "");
    const filePath = path.join(contentDirectory, file);
    const raw = fs.readFileSync(filePath, "utf8");
    const { content, meta } = parseFrontmatter(raw);

    entries.push([
      slug,
      {
        slug,
        title: meta.title || slug,
        description: meta.description,
        date: meta.date,
        order: normalizeOrder(meta.order),
        group: meta.group,
        content,
      },
    ]);
  }

  return Object.fromEntries(entries);
}

const generated = {
  en: buildLocaleDocs("en"),
  zh: buildLocaleDocs("zh"),
};

const output = `// This file is auto-generated by scripts/generate-docs-index.mjs.
// Do not edit manually.

export interface GeneratedDoc {
  slug: string;
  title: string;
  description?: string;
  date?: string;
  order?: number;
  group?: string;
  content: string;
}

export interface GeneratedDocsByLocale {
  en: Record<string, GeneratedDoc>;
  zh: Record<string, GeneratedDoc>;
}

export const GENERATED_DOCS: GeneratedDocsByLocale = ${JSON.stringify(
  generated,
  null,
  2
)};
`;

fs.writeFileSync(outputPath, output, "utf8");
console.log(`Generated docs index at ${path.relative(process.cwd(), outputPath)}`);
